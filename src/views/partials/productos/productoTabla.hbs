<style>
    :root {
        --qr-size: 120px; 
        --color-primary: #C73E3A; 
        --color-primary-dark: #8e0000;
        --color-primary-light: #ffebee;
        --color-text: #333;
        --color-border: #ddd;
        --color-white: #ffffff;
        --color-bg: #f5f5f5;
        --font-family-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        font-family: var(--font-family-primary);
        background-color: var(--color-bg);
        margin: 0;
        padding: 20px;
    }

    /* --- CONTENEDOR DE LA TARJETA --- */
    .table-container {
        /* 1. Eliminamos el truco de centrado que cortaba los lados */
        width: 100%; 
        max-width: 100%;
        
        background: var(--color-white);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        
        /* Padding interno de la tarjeta */
        padding: 20px; 
        margin-top: 20px;
        margin-bottom: 40px;
        box-sizing: border-box;
    }

    /* --- ZONA DE SCROLL (SOLUCIÓN) --- */
    .table-wrapper {
        width: 100%;
        display: block;
        
        /* 2. Forzamos el scroll horizontal AQUÍ MISMO */
        overflow-x: auto; 
        
        /* 3. Un poco de espacio abajo para que la barra de scroll no tape el contenido */
        padding-bottom: 15px; 
    }

    /* Estilo de la barra de scroll (Alta visibilidad) */
    .table-wrapper::-webkit-scrollbar {
        height: 14px; /* Barra gruesa para que sea fácil de clicar */
    }
    .table-wrapper::-webkit-scrollbar-track {
        background: #f1f1f1;
        border-radius: 7px;
    }
    .table-wrapper::-webkit-scrollbar-thumb {
        background-color: #C73E3A; /* Rojo de tu marca */
        border-radius: 7px;
        border: 3px solid #f1f1f1; /* Borde blanco para efecto flotante */
    }
    .table-wrapper::-webkit-scrollbar-thumb:hover {
        background-color: #8e0000;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        /* 4. Ancho mínimo gigante para OBLIGAR a que salga el scroll */
        min-width: 1600px; 
    }

    /* Encabezado */
    thead {
        background-color: var(--color-primary);
        color: var(--color-white);
    }

    thead th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        white-space: nowrap; /* Evita saltos de línea en encabezados */
        position: sticky; /* Fija el encabezado al hacer scroll vertical */
        top: 0;
        z-index: 10;
    }

    thead th.text-center { text-align: center; }

    /* Cuerpo */
    tbody tr {
        border-bottom: 1px solid var(--color-border);
        background-color: white;
    }
    tbody tr:hover {
        background-color: var(--color-primary-light);
    }

    tbody td {
        padding: 15px;
        vertical-align: middle; 
        color: var(--color-text);
        font-size: 0.95rem;
        /* 5. Evita que el texto se rompa, forzando la tabla a ser ancha */
        white-space: nowrap; 
    }

    tbody td.text-center { text-align: center; }
    .fw-bold { font-weight: 700; }

    /* === QR === */
    .qr-display {
        display: block;
        width: var(--qr-size) !important;      
        height: var(--qr-size) !important;     
        min-width: var(--qr-size);             
        object-fit: contain;
        background: white;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin: 0 auto;
    }

    /* Badges */
    .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
    .status-active { background-color: #d1fae5; color: #065f46; }
    .status-inactive { background-color: #fee2e2; color: #991b1b; }

    /* Acciones */
    .action-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
        min-width: 150px; /* Asegura espacio para botones */
        padding-right: 10px; 
        /* Sticky para que los botones siempre se vean a la derecha (Opcional, si quieres quítalo) */
        position: sticky; 
        right: 0;
        background-color: inherit; /* Hereda el color de fondo de la fila */
        z-index: 5;
        border-left: 2px solid #f0f0f0; /* Separador visual */
    }

    /* Ajuste para que el encabezado de acciones también sea sticky */
    thead th:last-child {
        position: sticky;
        right: 0;
        z-index: 20;
        background-color: var(--color-primary);
    }

    .btn-ver {
        background-color: var(--color-primary);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        width: 100%;
        text-align: center;
    }
    .btn-ver:hover { background-color: var(--color-primary-dark); }

    .link-group { display: flex; gap: 10px; font-size: 0.9rem; justify-content: center; }
    .link-action { color: #666; text-decoration: none; }
    .link-action:hover { color: var(--color-primary); text-decoration: underline; }
    .link-delete { color: #c62828; }

    /* --- MODAL --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); backdrop-filter: blur(2px); z-index: 998; display: none; }
    .modal-overlay.active { display: block; }
    .modal-ficha { 
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: min(520px, 92vw); max-height: 90vh; overflow-y: auto;
        background: var(--color-primary); color: white;
        border: 2px solid white; border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0,0,0,.55); padding: 20px; z-index: 999;
        display: none;
    }
    .modal-ficha.active { display: block; }
    .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; color: white; cursor: pointer; }
    .ficha-header h3 { margin: 0 0 15px 0; font-size: 1.4rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; }
    .ficha-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .ficha-label { font-weight: bold; opacity: 0.9; }
    .ficha-value { font-weight: 400; text-align: right; }
    .ficha-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 8px 16px; border-radius: 6px; font-weight: bold; text-decoration: none; cursor: pointer; border: none; }
    .btn-modal-primary { background: white; color: var(--color-primary); }
    .btn-modal-danger { background: #8B0000; color: white; }
    .btn-modal-ghost { background: transparent; color: white; border: 1px solid white; }
</style>

<div class="table-container">
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Categoría</th>
                    <th>Marca</th>
                    <th class="text-center">Precio</th>
                    <th>Color</th>
                    <th>Material</th>
                    <th class="text-center">QR</th>
                    <th class="text-center">Estado</th>
                    {{#if user.administrador}}
                    <th class="text-center">Acciones</th>
                    {{/if}}
                </tr>
            </thead>
            <tbody>
                {{#each productos}}
                <tr>
                    <td class="fw-bold">{{nombre}}</td>
                    <td>{{nombreCategoria}}</td>
                    <td>{{marca}}</td>
                    <td class="text-center fw-bold" style="font-size: 1.1rem;">${{precio}}</td>
                    <td>{{color}}</td>
                    <td>{{material}}</td>

                    <td class="text-center">
                        {{#if qr}}
                            <img src="{{qr}}" alt="QR Producto" class="qr-display">
                        {{else}}
                            <span style="color:#ccc; font-style: italic;">Sin QR</span>
                        {{/if}}
                    </td>

                    <td class="text-center">
                        {{#if activa}}
                        <span class="status-badge status-active">Activa</span>
                        {{else}}
                        <span class="status-badge status-inactive">Inactiva</span>
                        {{/if}}
                    </td>

                    {{#if ../user.administrador}}
                    <td class="text-center">
                        <div class="action-column">
                            <button class="btn-ver status-btn"
                                data-id="{{_id}}"
                                data-nombre="{{nombre}}"
                                data-categoria="{{nombreCategoria}}"
                                data-marca="{{marca}}"
                                data-precio="{{precio}}"
                                data-color="{{color}}"
                                data-material="{{material}}"
                                data-activa="{{#if activa}}Activa{{else}}Inactiva{{/if}}"
                                data-qr="{{qr}}"
                                data-edit="/editarProducto/{{_id}}"
                                data-delete="/eliminarProducto/{{_id}}">
                                Ver Detalles
                            </button>
                            <div class="link-group">
                                <a href="/editarProducto/{{_id}}" class="link-action">Editar</a> | 
                                <a href="/eliminarProducto/{{_id}}" class="link-action link-delete">Eliminar</a>
                            </div>
                        </div>
                    </td>
                    {{/if}}
                </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<div id="overlay-modal-ficha" class="modal-overlay"></div>
<div id="modal-ficha" class="modal-ficha">
    <button class="modal-close">×</button>
    <header class="ficha-header"><h3>Detalles del Producto</h3></header>
    <section class="ficha-body">
        <div class="ficha-row"><span class="ficha-label">Nombre</span><span id="ficha-nombre" class="ficha-value"></span></div>
        <div class="ficha-row"><span class="ficha-label">Categoría</span><span id="ficha-categoria" class="ficha-value"></span></div>
        <div class="ficha-row"><span class="ficha-label">Marca</span><span id="ficha-marca" class="ficha-value"></span></div>
        <div class="ficha-row"><span class="ficha-label">Precio</span><span id="ficha-precio" class="ficha-value" style="font-weight:bold; font-size:1.1em;"></span></div>
        <div class="ficha-row"><span class="ficha-label">Color</span><span id="ficha-color" class="ficha-value"></span></div>
        <div class="ficha-row"><span class="ficha-label">Material</span><span id="ficha-material" class="ficha-value"></span></div>
        <div class="ficha-row"><span class="ficha-label">Estado</span><span id="ficha-activa" class="ficha-value" style="font-weight:bold;"></span></div>

        <div style="text-align:center; margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2);">
            <span class="ficha-label" style="display:block; margin-bottom:5px;">Código QR</span>
            <img id="ficha-qr" src="#" style="max-width:120px; border-radius:8px; background:white; padding:5px;">
            <div id="qr-no-disponible" style="font-style:italic; opacity:0.7;">Sin QR</div>
        </div>
    </section>
    <footer class="ficha-actions">
        <a id="ficha-btn-editar" class="btn-modal btn-modal-primary" href="#">Editar</a>
        <a id="ficha-btn-eliminar" class="btn-modal btn-modal-danger" href="#">Eliminar</a>
        <button id="ficha-btn-cerrar" class="btn-modal btn-modal-ghost">Cerrar</button>
    </footer>
</div>

<script>
    (function () {
        const overlay = document.getElementById('overlay-modal-ficha');
        const modal = document.getElementById('modal-ficha');
        const closeBtn = modal.querySelector('.modal-close');
        const cerrarBtn = document.getElementById('ficha-btn-cerrar');
        
        const els = {
            nombre: document.getElementById('ficha-nombre'),
            categoria: document.getElementById('ficha-categoria'),
            marca: document.getElementById('ficha-marca'),
            precio: document.getElementById('ficha-precio'),
            color: document.getElementById('ficha-color'),
            material: document.getElementById('ficha-material'),
            activa: document.getElementById('ficha-activa'),
            qr: document.getElementById('ficha-qr'),
            qrNoDisp: document.getElementById('qr-no-disponible'),
            btnEdit: document.getElementById('ficha-btn-editar'),
            btnDel: document.getElementById('ficha-btn-eliminar')
        };

        function openModal() { 
            overlay.classList.add('active'); 
            modal.classList.add('active'); 
            document.body.style.overflow = 'hidden'; 
        }
        function closeModal() { 
            overlay.classList.remove('active'); 
            modal.classList.remove('active'); 
            document.body.style.overflow = ''; 
        }

        function fillCard(d) {
            els.nombre.textContent = d.nombre;
            els.categoria.textContent = d.categoria;
            els.marca.textContent = d.marca;
            els.precio.textContent = '$' + d.precio;
            els.color.textContent = d.color;
            els.material.textContent = d.material;
            
            els.activa.textContent = d.activa;
            if(d.activa === 'Activa') els.activa.style.color = '#90EE90'; 
            else els.activa.style.color = '#FFB6B6';

            if (d.qr && d.qr !== 'undefined' && d.qr !== "") {
                els.qr.src = d.qr;
                els.qr.style.display = 'inline-block';
                els.qrNoDisp.style.display = 'none';
            } else {
                els.qr.style.display = 'none';
                els.qrNoDisp.style.display = 'block';
            }
            
            els.btnEdit.href = d.edit;
            els.btnDel.href = d.delete;
        }

        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.status-btn');
            if (!btn) return;
            fillCard(btn.dataset);
            openModal();
        });

        closeBtn.addEventListener('click', closeModal);
        cerrarBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', closeModal);
        
        if(els.btnDel) {
            els.btnDel.addEventListener('click', (e) => {
                if(!confirm('¿Seguro que deseas eliminar este producto?')) e.preventDefault();
            });
        }
    })();
</script>