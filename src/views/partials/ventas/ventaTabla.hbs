<style>
  /* Contenedor desplazable horizontal para la tabla */
  .table-wrapper {
    width: 100%;
    overflow-x: auto;
    display: block;
    white-space: nowrap;
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  th, td {
    padding: 8px;
    text-align: left;
    vertical-align: top;
  }

  /* QR grande */
  .qr-zoom {
    width: 200px; /* ğŸ”¥ Ajusta si quieres aÃºn mÃ¡s grande */
    height: 200px;
    object-fit: contain;
    cursor: zoom-in;
    transition: transform 0.25s ease, box-shadow 0.25s ease;
    position: relative;
    z-index: 1;
  }

  /* Zoom centrado al pasar el mouse */
  .qr-zoom:hover {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%) scale(2.8);
    background: white;
    padding: 10px;
    border-radius: 8px;
    box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    z-index: 999999;
  }
  .dot { font-weight: bold; }
.dot.yes { color: green; }
.dot.no  { color: red; }

/* ----- Modal Ficha ----- */
.modal-overlay {
  position: fixed; inset: 0;
  background: rgba(0,0,0,.6);
  backdrop-filter: blur(1px);
  z-index: 998;
}

.modal-ficha {
  position: fixed; inset: 50% auto auto 50%;
  transform: translate(-50%, -50%);
  width: min(520px, 92vw);
  background: #2A4D31;          /* container background */
  color: #E4B767;               /* golden text */
  border: 2px solid #E4B767;
  border-radius: 16px;
  box-shadow: 0 20px 50px rgba(0,0,0,.55);
  padding: 20px 20px 16px;
  z-index: 999;
}

.modal-ficha[hidden],
.modal-overlay[hidden] { display: none; }

.modal-close {
  position: absolute; top: 8px; right: 10px;
  background: transparent; border: none;
  font-size: 22px; line-height: 1; cursor: pointer;
  color: #E4B767;
}

.ficha-header { margin-bottom: 10px; }
.ficha-header h3 {
  margin: 0; font-size: 1.25rem; letter-spacing: .3px;
}

.ficha-body { display: grid; gap: 10px; margin: 8px 0 14px; }
.ficha-row { display: grid; grid-template-columns: 1fr 2fr; gap: 8px; }
.ficha-label { opacity: .9; }
.ficha-value a, .ficha-value { color: #E4B767; text-decoration: none; word-break: break-all; }

.ficha-actions {
  display: flex; gap: 10px; justify-content: flex-end; flex-wrap: wrap;
}

/* Botones */
.btn {
  padding: 8px 14px; font-weight: 600;
  border-radius: 10px; border: 2px solid transparent;
  background: #1A3623; color: #E4B767; cursor: pointer;
  text-decoration: none; display: inline-block;
}
.btn:hover { filter: brightness(1.05); }

.btn-primary {
  border-color: #E4B767; background: transparent;
}
.btn-danger {
  border-color: #b74040; background: transparent; color: #ffbdbd;
}
.btn-danger:hover { background: #b74040; color: #fff; }
.btn-ghost {
  background: transparent; border-color: #3b5b45;
}

/* Evitar scroll del body con el modal abierto */
.body-no-scroll { overflow: hidden; }
</style>
<div class="table-wrapper">
<table border="1">
Â  Â  <thead>
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <th>Cliente</th>
Â  Â  Â  Â  Â  Â  <th>Fecha</th>
Â  Â  Â  Â  Â  Â  <th>Subtotal</th>
Â  Â  Â  Â  Â  Â  <th>Descuento</th>
Â  Â  Â  Â  Â  Â  <th>Impuestos</th>
Â  Â  Â  Â  Â  Â  <th>Total</th>
Â  Â  Â  Â  Â  Â  <th>Estado</th>
Â  Â  Â  Â  Â  Â  <th>MÃ©todo Pago</th>
Â  Â  Â  Â  Â  Â  <th>Notas</th>
Â  Â  Â  Â  Â  Â  <th>QR</th>
Â  Â  Â  Â  Â  Â  {{!-- Columna Acciones: SOLO ADMIN --}}
Â  Â  Â  Â  Â  Â  {{#if user.administrador}}
Â  Â  Â  Â  Â  Â  <th>Acciones</th>
Â  Â  Â  Â  Â  Â  {{/if}}
Â  Â  Â  Â  </tr>
Â  Â  </thead>

Â  Â  <tbody>
Â  Â  Â  Â  {{#each ventas}}
Â  Â  Â  Â  <tr>
Â  Â  Â  Â  Â  Â  <td>{{nombreCliente}}</td>
Â  Â  Â  Â  Â  Â  <td>{{formatDate fecha}}</td>
Â  Â  Â  Â  Â  Â  <td>{{formatCurrency subtotal}}</td>
Â  Â  Â  Â  Â  Â  <td>{{formatCurrency descuento}}</td>
Â  Â  Â  Â  Â  Â  <td>{{formatCurrency impuestos}}</td>
Â  Â  Â  Â  Â  Â  <td><strong>{{formatCurrency total}}</strong></td>

Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  {{#if (eq estado "Pagado")}}
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: green; font-weight: bold;">â— {{estado}}</span>
Â  Â  Â  Â  Â  Â  Â  Â  {{else if (eq estado "Pendiente")}}
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: orange; font-weight: bold;">â— {{estado}}</span>
Â  Â  Â  Â  Â  Â  Â  Â  {{else}}
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: red; font-weight: bold;">â— {{estado}}</span>
Â  Â  Â  Â  Â  Â  Â  Â  {{/if}}
Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  Â  Â  <td>{{metodo_pago}}</td>

Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  {{#if notas}}
Â  Â  Â  Â  Â  Â  Â  Â  <span title="{{notas}}" style="cursor: help; max-width: 200px; display: inline-block;">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  {{notas}}
Â  Â  Â  Â  Â  Â  Â  Â  </span>
Â  Â  Â  Â  Â  Â  Â  Â  {{else}}
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #999;">-</span>
Â  Â  Â  Â  Â  Â  Â  Â  {{/if}}
Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  {{#if qr}}
Â  Â  Â  Â  Â  Â  Â  Â  <img src="{{qr}}" alt="QR" class="qr-zoom" />
Â  Â  Â  Â  Â  Â  Â  Â  {{else}}
Â  Â  Â  Â  Â  Â  Â  Â  <span style="color: #999;">Sin QR</span>
Â  Â  Â  Â  Â  Â  Â  Â  {{/if}}
Â  Â  Â  Â  Â  Â  </td>

Â  Â  Â  Â  Â  Â  {{!-- Celdas de Acciones: SOLO ADMIN --}}
Â  Â  Â  Â  Â  Â  {{#if ../user.administrador}} 
Â  Â  Â  Â  Â  Â  <td>
Â  Â  Â  Â  Â  Â  Â  Â  <button
                    class="status-btn"
                    data-id="{{_id}}"
                    data-cliente="{{nombreCliente}}"
                    data-fecha="{{formatDate fecha}}"
                    data-subtotal="{{formatCurrency subtotal}}"
                    data-descuento="{{formatCurrency descuento}}"
                    data-impuestos="{{formatCurrency impuestos}}"
                    data-total="{{formatCurrency total}}"
                    data-estado="{{estado}}"
                    data-metodo-pago="{{metodo_pago}}"
                    data-notas="{{notas}}"
                    data-qr="{{qr}}"
                    data-edit="/editarVenta/{{_id}}"
                    data-delete="/eliminarVenta/{{_id}}"
                >Status</button>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/editarVenta/{{_id}}">Editar</a>
Â  Â  Â  Â  Â  Â  Â  Â  <a href="/eliminarVenta/{{_id}}">Eliminar</a>
Â  Â  Â  Â  Â  Â  </td>
Â  Â  Â  Â  Â  Â  {{/if}}
Â  Â  Â  Â  </tr>
Â  Â  Â  Â  {{/each}}
Â  Â  </tbody>
</table>
</div>

<div id="overlay-modal-ficha" class="modal-overlay" hidden></div>

<div id="modal-ficha" class="modal-ficha" role="dialog" aria-modal="true" aria-labelledby="ficha-title" hidden>
    <button class="modal-close" type="button" aria-label="Cerrar">Ã—</button>

    <header class="ficha-header">
        <h3 id="ficha-title">Detalles de la Venta</h3>
    </header>

    <section class="ficha-body">
        <div class="ficha-row">
            <span class="ficha-label">Cliente</span>
            <span id="ficha-cliente" class="ficha-value"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Fecha</span>
            <span id="ficha-fecha" class="ficha-value"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Subtotal</span>
            <span id="ficha-subtotal" class="ficha-value"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Descuento</span>
            <span id="ficha-descuento" class="ficha-value"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Impuestos</span>
            <span id="ficha-impuestos" class="ficha-value"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Total</span>
            <span id="ficha-total" class="ficha-value" style="font-weight: bold;"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">MÃ©todo Pago</span>
            <span id="ficha-metodo-pago" class="ficha-value"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Estado</span>
            <span id="ficha-estado" class="ficha-value" style="font-weight: bold;"></span>
        </div>
        <div class="ficha-row">
            <span class="ficha-label">Notas</span>
            <span id="ficha-notas" class="ficha-value"></span>
        </div>
        <div class="ficha-row qr-container">
            <span class="ficha-label">CÃ³digo QR</span>
            <span id="ficha-qr-wrapper" class="ficha-value">
                <img id="ficha-qr" src="#" alt="QR de la venta" style="max-width: 150px; height: auto;">
                <span id="qr-no-disponible" style="color: #999; font-style: italic;">Sin QR</span>
            </span>
        </div>
    </section>

    <footer class="ficha-actions">
        <a id="ficha-btn-editar" class="btn btn-primary" href="#">Editar</a>
        <a id="ficha-btn-eliminar" class="btn btn-danger" href="#">Eliminar</a>
        <button id="ficha-btn-cerrar" class="btn btn-ghost" type="button">Cerrar</button>
    </footer>
</div>
<script>
    (function () {
    // 1. Elementos del Modal y Overlay
    const overlay   = document.getElementById('overlay-modal-ficha');
    const modal     = document.getElementById('modal-ficha');
    const closeBtn  = modal.querySelector('.modal-close');
    const cerrarBtn = document.getElementById('ficha-btn-cerrar');

    // 2. Campos dentro de la Ficha (Modal)
    const elCliente     = document.getElementById('ficha-cliente');
    const elFecha       = document.getElementById('ficha-fecha');
    const elSubtotal    = document.getElementById('ficha-subtotal');
    const elDescuento   = document.getElementById('ficha-descuento');
    const elImpuestos   = document.getElementById('ficha-impuestos');
    const elTotal       = document.getElementById('ficha-total');
    const elMetodoPago  = document.getElementById('ficha-metodo-pago');
    const elEstado      = document.getElementById('ficha-estado');
    const elNotas       = document.getElementById('ficha-notas');
    const elQrImage     = document.getElementById('ficha-qr');
    const elQrNoDisp    = document.getElementById('qr-no-disponible');
    const btnEdit       = document.getElementById('ficha-btn-editar');
    const btnDel        = document.getElementById('ficha-btn-eliminar');

    // Funciones para abrir y cerrar el modal
    function openModal() {
        overlay.hidden = false;
        modal.hidden = false;
        document.body.classList.add('body-no-scroll');
    }

    function closeModal() {
        overlay.hidden = true;
        modal.hidden = true;
        document.body.classList.remove('body-no-scroll');
    }

    // FunciÃ³n para llenar la ficha con los datos del botÃ³n
    function fillCard({ cliente, fecha, subtotal, descuento, impuestos, total, metodoPago, estado, notas, qr, editUrl, deleteUrl }) {
        elCliente.textContent    = cliente || '';
        elFecha.textContent      = fecha || '';
        elSubtotal.textContent   = subtotal || '';
        elDescuento.textContent  = descuento || '';
        elImpuestos.textContent  = impuestos || '';
        elTotal.textContent      = total || '';
        elMetodoPago.textContent = metodoPago || '';
        elNotas.textContent      = notas || 'Sin notas';
        elNotas.style.color      = notas ? 'initial' : '#999';

        // Manejo del estado condicional (color)
        elEstado.textContent = estado || 'Desconocido';
        if (estado === "Pagado") {
            elEstado.style.color = 'green';
        } else if (estado === "Pendiente") {
            elEstado.style.color = 'orange';
        } else {
            elEstado.style.color = 'red';
        }

        // Manejo de la imagen QR
        if (qr && qr !== 'undefined' && qr !== '') {
            elQrImage.src = qr;
            elQrImage.hidden = false;
            elQrNoDisp.hidden = true;
        } else {
            elQrImage.src = '#';
            elQrImage.hidden = true;
            elQrNoDisp.hidden = false;
        }

        btnEdit.href = editUrl || '#';
        btnDel.href  = deleteUrl || '#';
    }

    // 3. DelegaciÃ³n de eventos para el botÃ³n "Status"
    document.addEventListener('click', function (e) {
        const btn = e.target.closest('.status-btn');
        if (!btn) return;

        const payload = {
            cliente: btn.dataset.cliente,
            fecha: btn.dataset.fecha,
            subtotal: btn.dataset.subtotal,
            descuento: btn.dataset.descuento,
            impuestos: btn.dataset.impuestos,
            total: btn.dataset.total,
            metodoPago: btn.dataset.metodoPago,
            estado: btn.dataset.estado,
            notas: btn.dataset.notas,
            qr: btn.dataset.qr,
            editUrl: btn.dataset.edit,
            deleteUrl: btn.dataset.delete
        };

        fillCard(payload);
        openModal();
    });

    // 4. Eventos para cerrar el modal
    closeBtn.addEventListener('click', closeModal);
    cerrarBtn.addEventListener('click', closeModal);
    overlay.addEventListener('click', closeModal);

    // Cerrar con tecla Escape
    document.addEventListener('keydown', function (e) {
        if (e.key === 'Escape' && !modal.hidden) closeModal();
    });

    // 5. ConfirmaciÃ³n para eliminar
    btnDel.addEventListener('click', function (e) {
        const ok = confirm('Â¿Seguro que deseas eliminar esta venta?');
        if (!ok) e.preventDefault();
    });
})();
</script>