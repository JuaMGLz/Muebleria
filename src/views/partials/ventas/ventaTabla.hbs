<style>
    :root {
        /* --- CONFIGURACIÓN VISUAL (Igual al primer ejemplo) --- */
        --qr-size: 150px; /* TAMAÑO DEL QR */
        
        --color-primary: #C73E3A; /* Rojo de tu marca */
        --color-primary-dark: #8e0000;
        --color-primary-light: #ffebee;
        --color-text: #333;
        --color-border: #ddd;
        --color-white: #ffffff;
        --color-bg: #f5f5f5;
        --font-family-primary: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
        font-family: var(--font-family-primary);
        background-color: var(--color-bg);
        margin: 0;
        padding: 20px;
    }

    /* Contenedor principal */
    .table-container {
        background: var(--color-white);
        border-radius: 8px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        overflow: hidden;
        padding: 20px;
        margin: 0 auto;
        width: 100%;
        box-sizing: border-box;
    }

    .table-wrapper {
        overflow-x: auto; /* Scroll horizontal si no cabe */
        width: 100%;
    }

    table {
        width: 100%;
        border-collapse: collapse;
        min-width: 1200px; /* Ancho mínimo para acomodar tantas columnas + QR grande */
    }

    /* Encabezado */
    thead {
        background-color: var(--color-primary);
        color: var(--color-white);
    }

    thead th {
        padding: 15px;
        text-align: left;
        font-weight: 600;
        text-transform: uppercase;
        font-size: 0.85rem;
        white-space: nowrap;
        position: sticky; /* Mantiene el header visible al bajar */
        top: 0;
    }

    thead th.text-center { text-align: center; }
    thead th.text-right { text-align: right; }

    /* Cuerpo */
    tbody tr {
        border-bottom: 1px solid var(--color-border);
        background-color: white;
    }

    tbody tr:hover {
        background-color: var(--color-primary-light);
    }

    tbody td {
        padding: 15px;
        /* ESTO ES CLAVE: Centra el texto verticalmente respecto al QR gigante */
        vertical-align: middle; 
        color: var(--color-text);
        font-size: 0.95rem;
        white-space: nowrap;
    }

    tbody td.text-center { text-align: center; }
    tbody td.text-right { text-align: right; }

    .fw-bold { font-weight: 700; }

    /* === QR GIGANTE (Estilo restaurado) === */
    .qr-display {
        display: block;
        width: var(--qr-size) !important;      
        height: var(--qr-size) !important;     
        min-width: var(--qr-size);             
        
        object-fit: contain;
        background: white;
        padding: 5px;
        border: 1px solid #ccc;
        border-radius: 8px;
        margin: 0 auto; /* Centrado horizontal */
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    /* Badges de estado */
    .status-badge { padding: 6px 14px; border-radius: 20px; font-size: 0.85rem; font-weight: 600; display: inline-block; }
    
    /* Columna de Acciones */
    .action-column {
        display: flex;
        flex-direction: column;
        gap: 8px;
        align-items: center;
        justify-content: center;
    }

    .btn-ver {
        background-color: var(--color-primary);
        color: white;
        border: none;
        padding: 8px 20px;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 600;
        font-size: 0.85rem;
        width: 100%;
        text-align: center;
    }
    .btn-ver:hover { background-color: var(--color-primary-dark); }

    .link-group { display: flex; gap: 10px; font-size: 0.9rem; }
    .link-action { color: #666; text-decoration: none; }
    .link-action:hover { color: var(--color-primary); text-decoration: underline; }
    .link-delete { color: #c62828; }

    /* Notas tooltip simple */
    .notas-cell {
        max-width: 150px;
        overflow: hidden;
        text-overflow: ellipsis;
        cursor: help;
    }

    /* --- ESTILOS DEL MODAL (Necesarios para tu script) --- */
    .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,.6); backdrop-filter: blur(2px); z-index: 998; display: none; }
    .modal-overlay.active { display: block; }
    .modal-ficha { 
        position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
        width: min(520px, 92vw); max-height: 90vh; overflow-y: auto;
        background: var(--color-primary); color: white;
        border: 2px solid white; border-radius: 16px;
        box-shadow: 0 20px 50px rgba(0,0,0,.55); padding: 20px; z-index: 999;
        display: none;
    }
    .modal-ficha.active { display: block; }
    
    .modal-close { position: absolute; top: 10px; right: 15px; background: none; border: none; font-size: 24px; color: white; cursor: pointer; }
    .ficha-header h3 { margin: 0 0 15px 0; font-size: 1.4rem; border-bottom: 1px solid rgba(255,255,255,0.3); padding-bottom: 10px; }
    .ficha-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid rgba(255,255,255,0.1); }
    .ficha-label { font-weight: bold; opacity: 0.9; }
    .ficha-actions { margin-top: 20px; display: flex; justify-content: flex-end; gap: 10px; }
    .btn-modal { padding: 8px 16px; border-radius: 6px; font-weight: bold; text-decoration: none; cursor: pointer; border: none; }
    .btn-modal-primary { background: white; color: var(--color-primary); }
    .btn-modal-danger { background: #8B0000; color: white; }
    .btn-modal-ghost { background: transparent; color: white; border: 1px solid white; }
</style>

<div class="table-container">
    <div class="table-wrapper">
        <table>
            <thead>
                <tr>
                    <th>Cliente</th>
                    <th>Fecha</th>
                    <th class="text-right">Subtotal</th>
                    <th class="text-right">Desc.</th>
                    <th class="text-right">Imp.</th>
                    <th class="text-right">Total</th>
                    <th class="text-center">Estado</th>
                    <th>Método Pago</th>
                    <th>Notas</th>
                    <th class="text-center">QR</th>
                    
                    <th class="text-center">Acciones</th>
                    </tr>
            </thead>

            <tbody>
                {{#each ventas}}
                <tr>
                    <td class="fw-bold">{{nombreCliente}}</td>
                    <td>{{formatDate fecha}}</td>
                    <td class="text-right">{{formatCurrency subtotal}}</td>
                    <td class="text-right">{{formatCurrency descuento}}</td>
                    <td class="text-right">{{formatCurrency impuestos}}</td>
                    <td class="text-right fw-bold" style="font-size: 1.1rem;">{{formatCurrency total}}</td>

                    <td class="text-center">
                        {{#if (eq estado "Pagado")}}
                            <span class="status-badge" style="background:#d1fae5; color:#065f46;">Pagado</span>
                        {{else if (eq estado "Pendiente")}}
                            <span class="status-badge" style="background:#ffedd5; color:#9a3412;">Pendiente</span>
                        {{else}}
                            <span class="status-badge" style="background:#fee2e2; color:#991b1b;">{{estado}}</span>
                        {{/if}}
                    </td>

                    <td>{{metodo_pago}}</td>

                    <td>
                        {{#if notas}}
                            <span class="notas-cell" title="{{notas}}">{{notas}}</span>
                        {{else}}
                            <span style="color: #ccc;">--</span>
                        {{/if}}
                    </td>

                    <td class="text-center">
                        {{#if qr}}
                            <img src="{{qr}}" alt="QR Venta" class="qr-display" />
                        {{else}}
                            <span style="color: #ccc; font-style: italic;">Sin QR</span>
                        {{/if}}
                    </td>

                    <td class="text-center">
                        <div class="action-column">
                            <button class="btn-ver status-btn"
                                data-id="{{_id}}"
                                data-cliente="{{nombreCliente}}"
                                data-fecha="{{formatDate fecha}}"
                                data-subtotal="{{formatCurrency subtotal}}"
                                data-descuento="{{formatCurrency descuento}}"
                                data-impuestos="{{formatCurrency impuestos}}"
                                data-total="{{formatCurrency total}}"
                                data-estado="{{estado}}"
                                data-metodo-pago="{{metodo_pago}}"
                                data-notas="{{notas}}"
                                data-qr="{{qr}}"
                                data-edit="/editarVenta/{{_id}}"
                                data-delete="/eliminarVenta/{{_id}}"
                            >
                                Ver Estado
                            </button>
                            
                            <div class="link-group">
                                <a href="/editarVenta/{{_id}}" class="link-action">Editar</a> | 
                                <a href="/eliminarVenta/{{_id}}" class="link-action link-delete">Eliminar</a>
                            </div>
                        </div>
                    </td>
                    </tr>
                {{/each}}
            </tbody>
        </table>
    </div>
</div>

<div id="overlay-modal-ficha" class="modal-overlay"></div>
<div id="modal-ficha" class="modal-ficha">
    <button class="modal-close">×</button>
    <header class="ficha-header"><h3>Detalles de la Venta</h3></header>
    <section class="ficha-body">
        <div class="ficha-row"><span class="ficha-label">Cliente</span><span id="ficha-cliente"></span></div>
        <div class="ficha-row"><span class="ficha-label">Fecha</span><span id="ficha-fecha"></span></div>
        <div class="ficha-row"><span class="ficha-label">Subtotal</span><span id="ficha-subtotal"></span></div>
        <div class="ficha-row"><span class="ficha-label">Descuento</span><span id="ficha-descuento"></span></div>
        <div class="ficha-row"><span class="ficha-label">Impuestos</span><span id="ficha-impuestos"></span></div>
        <div class="ficha-row"><span class="ficha-label">Total</span><span id="ficha-total" style="font-weight:bold;"></span></div>
        <div class="ficha-row"><span class="ficha-label">Método Pago</span><span id="ficha-metodo-pago"></span></div>
        <div class="ficha-row"><span class="ficha-label">Estado</span><span id="ficha-estado" style="font-weight:bold;"></span></div>
        <div class="ficha-row"><span class="ficha-label">Notas</span><span id="ficha-notas" style="font-size:0.9rem;"></span></div>
        
        <div style="text-align:center; margin-top:15px; padding-top:10px; border-top:1px solid rgba(255,255,255,0.2);">
            <span class="ficha-label" style="display:block; margin-bottom:5px;">Código QR</span>
            <img id="ficha-qr" src="#" style="max-width:120px; border-radius:8px; background:white; padding:5px;">
            <div id="qr-no-disponible" style="font-style:italic; opacity:0.7;">Sin QR</div>
        </div>
    </section>
    <footer class="ficha-actions">
        <a id="ficha-btn-editar" class="btn-modal btn-modal-primary" href="#">Editar</a>
        <a id="ficha-btn-eliminar" class="btn-modal btn-modal-danger" href="#">Eliminar</a>
        <button id="ficha-btn-cerrar" class="btn-modal btn-modal-ghost">Cerrar</button>
    </footer>
</div>

<script>
    (function () {
        const overlay = document.getElementById('overlay-modal-ficha');
        const modal = document.getElementById('modal-ficha');
        const closeBtn = modal.querySelector('.modal-close');
        const cerrarBtn = document.getElementById('ficha-btn-cerrar');
        
        const els = {
            cliente: document.getElementById('ficha-cliente'),
            fecha: document.getElementById('ficha-fecha'),
            subtotal: document.getElementById('ficha-subtotal'),
            descuento: document.getElementById('ficha-descuento'),
            impuestos: document.getElementById('ficha-impuestos'),
            total: document.getElementById('ficha-total'),
            metodoPago: document.getElementById('ficha-metodo-pago'),
            estado: document.getElementById('ficha-estado'),
            notas: document.getElementById('ficha-notas'),
            qr: document.getElementById('ficha-qr'),
            qrNoDisp: document.getElementById('qr-no-disponible'),
            btnEdit: document.getElementById('ficha-btn-editar'),
            btnDel: document.getElementById('ficha-btn-eliminar')
        };

        // Función para abrir/cerrar usando clases active en lugar de hidden
        function openModal() { 
            overlay.classList.add('active'); 
            modal.classList.add('active'); 
            document.body.style.overflow = 'hidden'; 
        }
        function closeModal() { 
            overlay.classList.remove('active'); 
            modal.classList.remove('active'); 
            document.body.style.overflow = ''; 
        }

        function fillCard(d) {
            els.cliente.textContent = d.cliente;
            els.fecha.textContent = d.fecha;
            els.subtotal.textContent = d.subtotal;
            els.descuento.textContent = d.descuento;
            els.impuestos.textContent = d.impuestos;
            els.total.textContent = d.total;
            els.metodoPago.textContent = d.metodoPago;
            els.notas.textContent = d.notas || '---';
            
            els.estado.textContent = d.estado;
            // Ajuste de colores dentro del modal (fondo rojo, texto blanco/variantes)
            if(d.estado === 'Pagado') els.estado.style.color = '#90EE90'; // Verde claro
            else if(d.estado === 'Pendiente') els.estado.style.color = '#FFD700'; // Dorado
            else els.estado.style.color = '#FFB6B6'; // Rojo claro

            if (d.qr && d.qr !== 'undefined' && d.qr !== "") {
                els.qr.src = d.qr;
                els.qr.style.display = 'inline-block';
                els.qrNoDisp.style.display = 'none';
            } else {
                els.qr.style.display = 'none';
                els.qrNoDisp.style.display = 'block';
            }
            els.btnEdit.href = d.edit;
            els.btnDel.href = d.delete;
        }

        document.addEventListener('click', function (e) {
            const btn = e.target.closest('.status-btn');
            if (!btn) return;
            fillCard(btn.dataset);
            openModal();
        });

        closeBtn.addEventListener('click', closeModal);
        cerrarBtn.addEventListener('click', closeModal);
        overlay.addEventListener('click', closeModal);
        
        if(els.btnDel) {
            els.btnDel.addEventListener('click', (e) => {
                if(!confirm('¿Seguro que deseas eliminar esta venta?')) e.preventDefault();
            });
        }
    })();
</script>